<div id="calendar-past-events"></div>
<button id="load-more">Показать более ранние события</button>

<script>
'use strict';

const CARD_MONTH = ["января", "февраля", "марта", "апреля", "мая", "июня", "июля", "августа", "сентября", "октября", "ноября", "декабря"];
const HEAD_MONTH = ["январь", "февраль", "март", "апрель", "май", "июнь", "июль", "август", "сентябрь", "октябрь", "ноябрь", "декабрь"];
let month_num;
const output = document.getElementById('calendar-past-events');
const loadMoreButton = document.getElementById("load-more");


const cardIncrease = 10;
let currentPage = 0;

(async () => {
    const APP = "https://script.google.com/macros/s/AKfycby5wIU62Fm_FogxKaIulUoCeeVsiYnfrsDwR1uxr5UQoAoZq120tGfVsNvYG6MJJyWQ/exec";
    let xhr = await fetch(APP);
    if (xhr.ok) {
        let r = await xhr.json(); // читаем ответ в формате JSON
        const result = r.calendar;
        const cardLimit = result.length;


        const pageCount = Math.ceil(cardLimit / cardIncrease) - 1;
        console.log('pagecount', pageCount);
        

        addCards(currentPage, result, cardLimit, pageCount);
        loadMoreButton.addEventListener("click", () => {
            addCards(currentPage + 1, result, cardLimit, pageCount);
          });


/*
        for (let i = 0; i < cardLimit; i++) {
            createCalendarCard(i, r.calendar[i]);
        {*/

/*            let obj = r.calendar[i];
            let s_date, e_date, s_time, e_time;   //даты начала и конца и времена начала и конца мероприятия
            s_date = obj[0].split('-'); //в массив s_date (start date) записываются год, месяц и день начала мероприятия
            if (obj[2] != '') { //если есть вторая дата
                e_date = obj[2].split('-'); //в массив e_date (end date) записываются год, месяц и день конца мероприятия
            }
            if (obj[1] != '') {
                s_time = obj[1]; //в переменную s_time (start time) записываются время начала мероприятия
            }
            if (obj[3] != '') {
                e_time = obj[3]; //в переменную e_time (end time) записываются время конца мероприятия
            }

            if (s_date[1] != month_num) { //если номер месяца не совпадает с номером месяца предыдущего события, добавляем название месяца и года перед карточкой
                // let hMonth;
                month_num = s_date[1];
                appendElement(output, 'h_month', null, HEAD_MONTH[s_date[1] - 1] + ' ' + s_date[0]);
            }
            
            const c_card = appendElement(output, 'c_card', null, null);
            appendElement(c_card, 'c_about', null, obj[6].replace(/&nbsp;|#nbsp;/gi, '\u00A0'));
            if ((obj[2] == '') && (obj[2] != obj[0])) {
                appendElement(c_card, 'c_day', null, s_date[2]);
            } else {
                appendElement(c_card, 'c_days', null, s_date[2] + ' – ' + e_date[2]);
            }
            appendElement(c_card, 'c_month', null, CARD_MONTH[s_date[1] - 1]);
            if (obj[3] == '') {
                appendElement(c_card, 'c_time', null, obj[1]);
            } else {
                appendElement(c_card, 'c_time', null, obj[1] + ' – ' + obj[3]);
            }
            appendElement(c_card, 'c_type', null, obj[5]);
            appendElement(c_card, 'c_placetag', null, 'Место');
            appendElement(c_card, 'c_place', null, obj[7].replace(/&nbsp;|#nbsp;/gi, '\u00A0'));
            
      
            if (obj[8] != '') { // если есть ссылка на описание мероприятия
                let c_link = document.createElement('div');
                let a_link = document.createElement('a');
                let a_linkText = document.createTextNode('Описание');
                a_link.target = '_blank';
                a_link.href = obj[8];
                a_link.appendChild(a_linkText);
                c_link.appendChild(a_link);
                c_link.setAttribute('class', 'c_link');
                c_card.appendChild(c_link);
            }
*/        
   } else return;
})()


function appendElement(parent, childName, id, content) {
    var child = childName;
    child = document.createElement('div');
    if (id) {
        child.setAttribute('id', obj[0] + 'T' + obj[1]);
    }
    child.setAttribute('class', childName);
    child.textContent = content;
    parent.appendChild(child);
    return child;
}

function createCalendarCard(i,jsoncalendarevent) {
            let obj = jsoncalendarevent;
            let s_date, e_date, s_time, e_time;   //даты начала и конца и времена начала и конца мероприятия
            s_date = obj[0].split('-'); //в массив s_date (start date) записываются год, месяц и день начала мероприятия
            if (obj[2] != '') { //если есть вторая дата
                e_date = obj[2].split('-'); //в массив e_date (end date) записываются год, месяц и день конца мероприятия
            }
            if (obj[1] != '') {
                s_time = obj[1]; //в переменную s_time (start time) записываются время начала мероприятия
            }
            if (obj[3] != '') {
                e_time = obj[3]; //в переменную e_time (end time) записываются время конца мероприятия
            }

            if (s_date[1] != month_num) { //если номер месяца не совпадает с номером месяца предыдущего события, добавляем название месяца и года перед карточкой
                // let hMonth;
                month_num = s_date[1];
                appendElement(output, 'h_month', null, HEAD_MONTH[s_date[1] - 1] + ' ' + s_date[0]);
            }
            
            const c_card = appendElement(output, 'c_card', null, null);
            appendElement(c_card, 'c_about', null, obj[6].replace(/&nbsp;|#nbsp;/gi, '\u00A0'));
            if ((obj[2] == '') && (obj[2] != obj[0])) {
                appendElement(c_card, 'c_day', null, s_date[2]);
            } else {
                appendElement(c_card, 'c_days', null, s_date[2] + ' – ' + e_date[2]);
            }
            appendElement(c_card, 'c_month', null, CARD_MONTH[s_date[1] - 1]);
            if (obj[3] == '') {
                appendElement(c_card, 'c_time', null, obj[1]);
            } else {
                appendElement(c_card, 'c_time', null, obj[1] + ' – ' + obj[3]);
            }
            appendElement(c_card, 'c_type', null, obj[5]);
            appendElement(c_card, 'c_placetag', null, 'Место');
            appendElement(c_card, 'c_place', null, obj[7].replace(/&nbsp;|#nbsp;/gi, '\u00A0'));
            
      
            if (obj[8] != '') { // если есть ссылка на описание мероприятия
                let c_link = document.createElement('div');
                let a_link = document.createElement('a');
                let a_linkText = document.createTextNode('Описание');
                a_link.target = '_blank';
                a_link.href = obj[8];
                a_link.appendChild(a_linkText);
                c_link.appendChild(a_link);
                c_link.setAttribute('class', 'c_link');
                c_card.appendChild(c_link);
            }

}

function handleButtonStatus(pageCount, currentPage) {
    console.log ('handleButtonStatus: pageCount= ', pageCount, 'currentPage= ', currentPage);
  if (pageCount === currentPage) {
    loadMoreButton.classList.add("disabled");
    loadMoreButton.setAttribute("disabled", true);
  }
}

function addCards(pageIndex, jsoncalendar, cardLimit, pageCount) {
    
    console.log ('addCards: pageCount= ', pageCount, 'pageIndex= ', pageIndex, 'currentPage= ', currentPage);
    
  currentPage = pageIndex;

  handleButtonStatus(pageCount, currentPage);

  const startRange = pageIndex * cardIncrease;
  const endRange = ((pageIndex + 1) * cardIncrease > cardLimit) ? cardLimit : (pageIndex + 1) * cardIncrease;

  console.log(pageIndex, cardIncrease, cardLimit, 'endRange = ', endRange);
  for (let i = startRange; i < endRange; i++) {
    createCalendarCard(i, jsoncalendar[i]);
  }
}



/*
            if (s_date[1] != month_num) { //если номер месяца не совпадает с номером месяца предыдущего события, добавляем название месяца и года перед карточкой
                let month_num = s_date[1];
                hMonth = document.createElement('div');
                hMonth.setAttribute('class', 'h_month');
                hMonth.textContent = HEAD_MONTH[s_date[1] - 1] + ' ' + s_date[0];
                output.appendChild(hMonth);
            }
            */
/*            let c_card = document.createElement('div');
            c_card.setAttribute('id', obj[0] + 'T' + obj[1]);
            c_card.setAttribute('class', 'c_card');
            output.appendChild(c_card);
            let c_about = document.createElement('div');
            c_about.setAttribute('class', 'c_about');
            c_about.textContent = obj[6].replace(/&nbsp;|#nbsp;/gi, '\u00A0'); // неразрывный пробел
            c_card.appendChild(c_about); //описание - идет первым, потому что у нее position relative
            
           
            let c_day = document.createElement('div');
            if ((obj[2] == '') && (obj[2] != obj[0])) {
                c_day.setAttribute('class', 'c_day');
                c_day.textContent = s_date[2]; //если нет конечной дат или она совпадает с начальной (событие на один день) пишем одно число месяца
            } else {
                c_day.setAttribute('class', 'c_days');
                c_day.textContent = s_date[2] + ' – ' + e_date[2]; //если есть вторая дата, пишем обе через короткое тире
            }
            c_card.appendChild(c_day);
            
            let c_month = document.createElement('div');
            c_month.setAttribute('class', 'c_month');
            c_month.textContent = CARD_MONTH[s_date[1] - 1]; // название месяца из массива, 1 вычитается потому, что массив начинается с 0. Диапазон месяцев пока не придумал как писать
            c_card.appendChild(c_month);
*/
/*
            let c_time = document.createElement('div');
            c_time.setAttribute('class', 'c_time');
            if (obj[3] == '') {
                c_time.textContent = obj[1];
            } else {
                c_time.textContent = obj[1] + ' – ' + obj[3];
            }
            c_card.appendChild(c_time);
            
            let c_type = document.createElement('div');
            c_type.setAttribute('class', 'c_type');
            c_type.textContent = obj[5];
            c_card.appendChild(c_type);
            let c_placetag = document.createElement('div');
            c_placetag.setAttribute('class', 'c_placetag');
            c_placetag.textContent = 'Место';
            c_card.appendChild(c_placetag);
            let c_place = document.createElement('div');
            c_place.setAttribute('class', 'c_place');
            c_place.textContent = obj[7].replace(/&nbsp;|#nbsp;/gi, '\u00A0'); // неразрывный пробел;
            c_card.appendChild(c_place);
*/       
</script>
